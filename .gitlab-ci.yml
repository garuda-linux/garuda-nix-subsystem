---
stages: [update, test, tag]
variables:
  GIT_AUTHOR_EMAIL: ci@garudalinux.org
  GIT_AUTHOR_NAME: Gitlab CI
  GIT_STRATEGY: clone
  REPO_URL: $CI_SERVER_PROTOCOL://gitlab-ci-token:$ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git
update:
  stage: update
  image: nixpkgs/nix-flakes:latest
  script:
    - nix flake update
    - git config --global user.name "$GIT_AUTHOR_NAME"
    - git config --global user.email "$GIT_AUTHOR_EMAIL"
    - git add flake.lock
    - "git commit -m 'chore(flake.lock): bump flakes'"
    - git push "$REPO_URL" HEAD:main
  only:
    variables: [$UPDATE == "true"]
    refs: [main]
test:
  stage: test
  image: nixpkgs/nix-flakes:latest
  script:
    - nix flake check
  only:
    refs: [main]
tag:
  stage: tag
  image: nixpkgs/nix-flakes:latest
  script:
    - nix build .#internal.vm --dry-run
    - git tag -f v1
    - git push --atomic -f $REPO_URL v1 HEAD:refs/heads/stable
  only:
    refs: [main]
    variables: [$UPDATE != "true"]
